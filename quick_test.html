<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê¹… ì‹œìŠ¤í…œ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 8px; 
            font-size: 14px;
            min-width: 150px;
        }
        .button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .result { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 15px; 
            margin: 15px 0; 
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ë¡œê¹… ì‹œìŠ¤í…œ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸</h1>
        <p>í˜„ì¬ ë¸Œëœì¹˜ì—ì„œ ë¡œê¹… ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
        
        <div id="status" class="status info">í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘...</div>
        
        <div style="margin: 20px 0;">
            <button class="button" onclick="runBasicTest()">ê¸°ë³¸ ë¡œê¹… í…ŒìŠ¤íŠ¸</button>
            <button class="button" onclick="runErrorTest()">ì—ëŸ¬ ë¡œê¹… í…ŒìŠ¤íŠ¸</button>
            <button class="button" onclick="runPerformanceTest()">ì„±ëŠ¥ ë¡œê¹… í…ŒìŠ¤íŠ¸</button>
            <button class="button success" onclick="runFullTest()">ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        </div>
        
        <div style="margin: 20px 0;">
            <button class="button" onclick="checkSupabaseConnection()">Supabase ì—°ê²° í™•ì¸</button>
            <button class="button" onclick="checkLocalStorage()">ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸</button>
            <button class="button danger" onclick="clearResults()">ê²°ê³¼ ì´ˆê¸°í™”</button>
        </div>
        
        <div id="results" class="result">í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <!-- í•„ìš”í•œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="logging.js"></script>

    <script>
        let testLogManager = null;
        let testResults = [];

        // ì´ˆê¸°í™”
        async function initializeTest() {
            try {
                updateStatus('ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...', 'info');
                
                let supabaseClient = null;
                if (typeof supabaseConfig !== 'undefined' && supabaseConfig.initialized) {
                    supabaseClient = supabaseConfig.getClient();
                    addResult('âœ… Supabase ì„¤ì • í™•ì¸ë¨');
                } else {
                    addResult('âš ï¸ Supabase ì„¤ì • ì—†ìŒ - LocalStorage ëª¨ë“œ');
                }

                testLogManager = await initializeLogManager(supabaseClient);
                testLogManager.setUser(999); // í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ID
                
                addResult('âœ… ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
                updateStatus('í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ', 'success');
                
            } catch (error) {
                addResult('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
                updateStatus('ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            }
        }

        // ê¸°ë³¸ ë¡œê¹… í…ŒìŠ¤íŠ¸
        async function runBasicTest() {
            if (!testLogManager) {
                addResult('âŒ ë¡œê¹… ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                addResult('\n=== ê¸°ë³¸ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                
                // ê°ì¢… ë¡œê·¸ íƒ€ì… í…ŒìŠ¤íŠ¸
                await testLogManager.log(LOG_ACTIONS.PAGE_VIEW, 'test_page', {test: true});
                addResult('âœ… í˜ì´ì§€ ë·° ë¡œê·¸ ìƒì„±');
                
                await testLogManager.log(LOG_ACTIONS.USER_REGISTER, 'test_user', {name: 'í…ŒìŠ¤íŠ¸'});
                addResult('âœ… ì‚¬ìš©ì ë“±ë¡ ë¡œê·¸ ìƒì„±');
                
                await testLogManager.log(LOG_ACTIONS.LESSON_COMPLETE, 'test_lesson', {lessonId: 1});
                addResult('âœ… ê°•ì˜ ì™„ë£Œ ë¡œê·¸ ìƒì„±');
                
                addResult('âœ… ê¸°ë³¸ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n');
                
            } catch (error) {
                addResult('âŒ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì—ëŸ¬ ë¡œê¹… í…ŒìŠ¤íŠ¸
        async function runErrorTest() {
            if (!testLogManager) {
                addResult('âŒ ë¡œê¹… ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                addResult('\n=== ì—ëŸ¬ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                
                const testError = new Error('í…ŒìŠ¤íŠ¸ ì—ëŸ¬');
                testError.stack = 'Test Error Stack\n  at runErrorTest';
                
                await testLogManager.logError(testError, 'quick_test');
                addResult('âœ… ì—ëŸ¬ ë¡œê·¸ ìƒì„±');
                
                await testLogManager.log(LOG_ACTIONS.VALIDATION_ERROR, 'test_validation', {field: 'email'});
                addResult('âœ… ìœ íš¨ì„± ê²€ì‚¬ ì—ëŸ¬ ë¡œê·¸ ìƒì„±');
                
                addResult('âœ… ì—ëŸ¬ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n');
                
            } catch (error) {
                addResult('âŒ ì—ëŸ¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì„±ëŠ¥ ë¡œê¹… í…ŒìŠ¤íŠ¸
        async function runPerformanceTest() {
            if (!testLogManager) {
                addResult('âŒ ë¡œê¹… ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                addResult('\n=== ì„±ëŠ¥ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                
                const startTime = performance.now();
                
                // ê°€ì§œ ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const duration = performance.now() - startTime;
                
                await testLogManager.logPerformance('test_operation', duration, {
                    testData: 'performance_test'
                });
                
                addResult(`âœ… ì„±ëŠ¥ ë¡œê·¸ ìƒì„± (${duration.toFixed(2)}ms)`);
                addResult('âœ… ì„±ëŠ¥ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n');
                
            } catch (error) {
                addResult('âŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runFullTest() {
            addResult('\nğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘...\n');
            updateStatus('ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...', 'info');
            
            await runBasicTest();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runErrorTest();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runPerformanceTest();
            
            // ìš”ì•½ ì •ë³´
            addResult('=== í…ŒìŠ¤íŠ¸ ìš”ì•½ ===');
            addResult(`ìƒì„±ëœ ë¡œê·¸ ìˆ˜: ${testLogManager?.logs?.length || 0}`);
            addResult(`ì„±ëŠ¥ ë©”íŠ¸ë¦­: ${JSON.stringify(testLogManager?.getPerformanceMetrics() || {})}`);
            
            updateStatus('ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ', 'success');
        }

        // Supabase ì—°ê²° í™•ì¸
        async function checkSupabaseConnection() {
            try {
                addResult('\n=== Supabase ì—°ê²° í™•ì¸ ===');
                
                if (typeof supabaseConfig === 'undefined') {
                    addResult('âŒ supabaseConfigê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                if (!supabaseConfig.initialized) {
                    addResult('âŒ Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                const client = supabaseConfig.getClient();
                addResult('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±ë¨');
                
                // ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸ (user_activity_logs í…Œì´ë¸” í™•ì¸)
                const { data, error } = await client
                    .from('user_activity_logs')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    addResult('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                } else {
                    addResult('âœ… Supabase ì—°ê²° ì„±ê³µ');
                    addResult(`ğŸ“Š í˜„ì¬ ë¡œê·¸ ê°œìˆ˜: ${data || 0}`);
                }
                
            } catch (error) {
                addResult('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸
        function checkLocalStorage() {
            addResult('\n=== ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸ ===');
            
            try {
                const queue = localStorage.getItem('knou_log_queue');
                if (queue) {
                    const parsed = JSON.parse(queue);
                    addResult(`ğŸ“¦ ë¡œì»¬ íì— ${parsed.length}ê°œ ë¡œê·¸ ì €ì¥ë¨`);
                } else {
                    addResult('ğŸ“¦ ë¡œì»¬ í ë¹„ì–´ìˆìŒ');
                }
                
                // í…ŒìŠ¤íŠ¸ ì €ì¥
                localStorage.setItem('logging_test', 'test_value');
                const testValue = localStorage.getItem('logging_test');
                localStorage.removeItem('logging_test');
                
                if (testValue === 'test_value') {
                    addResult('âœ… ë¡œì»¬ ì €ì¥ì†Œ ì •ìƒ ì‘ë™');
                } else {
                    addResult('âŒ ë¡œì»¬ ì €ì¥ì†Œ ë¬¸ì œ');
                }
                
            } catch (error) {
                addResult('âŒ ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function addResult(message) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push(`[${timestamp}] ${message}`);
            document.getElementById('results').textContent = testResults.join('\n');
            
            // ìë™ ìŠ¤í¬ë¡¤
            const resultsEl = document.getElementById('results');
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        function clearResults() {
            testResults = [];
            document.getElementById('results').textContent = 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...';
            updateStatus('ê²°ê³¼ ì´ˆê¸°í™”ë¨', 'info');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', initializeTest);
    </script>
</body>
</html>