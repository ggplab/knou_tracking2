<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로깅 시스템 디버깅</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f8f9fa;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 4px; 
            font-size: 12px;
        }
        .button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #000; }
        .code { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 12px; 
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .status { 
            padding: 8px 12px; 
            border-radius: 4px; 
            margin: 8px 0; 
            font-size: 13px;
        }
        .status.ok { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h3 { margin-top: 0; color: #495057; }
        .inline { display: inline-block; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 로깅 시스템 실시간 디버깅</h1>
        <p>현재 로깅 시스템의 상태를 실시간으로 확인하고 문제를 진단합니다.</p>
        
        <div>
            <button class="button success" onclick="runFullDiagnosis()">🔍 전체 진단 실행</button>
            <button class="button" onclick="testActualLogging()">📝 실제 로깅 테스트</button>
            <button class="button" onclick="checkSupabaseTable()">🗄️ Supabase 테이블 확인</button>
            <button class="button warning" onclick="clearAllLogs()">🗑️ 로컬 로그 삭제</button>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>시스템 상태</h3>
            <div id="system-status">진단 중...</div>
        </div>
        
        <div class="container">
            <h3>Supabase 연결</h3>
            <div id="supabase-status">확인 중...</div>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>로컬 스토리지 상태</h3>
            <div id="localStorage-status">확인 중...</div>
        </div>
        
        <div class="container">
            <h3>실시간 로그 모니터</h3>
            <div id="live-logs" class="code">로그가 여기에 표시됩니다...</div>
        </div>
    </div>

    <div class="container">
        <h3>Supabase 실시간 테이블 조회</h3>
        <button class="button inline" onclick="queryRecentLogs()">최근 로그 조회</button>
        <button class="button inline" onclick="queryLogCount()">로그 개수 확인</button>
        <button class="button inline" onclick="insertTestLog()">테스트 로그 직접 삽입</button>
        <div id="supabase-query-result" class="code">쿼리 결과가 여기에 표시됩니다...</div>
    </div>

    <!-- 스크립트 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="logging.js"></script>

    <script>
        let debugLogManager = null;
        let supabaseClient = null;
        let liveLogCount = 0;

        // 전체 진단 실행
        async function runFullDiagnosis() {
            updateStatus('system-status', '🔍 전체 진단 실행 중...', 'warning');
            
            // 1. 기본 객체들 확인
            await checkBasicObjects();
            
            // 2. Supabase 연결 확인
            await checkSupabaseConnection();
            
            // 3. 로컬 스토리지 확인
            checkLocalStorageStatus();
            
            // 4. 로깅 시스템 초기화
            await initializeLoggingSystem();
            
            updateStatus('system-status', '✅ 전체 진단 완료', 'ok');
        }

        // 기본 객체들 확인
        async function checkBasicObjects() {
            let status = [];
            
            // 전역 객체들 확인
            status.push(`supabaseConfig: ${typeof supabaseConfig !== 'undefined' ? '✅' : '❌'}`);
            status.push(`LOG_ACTIONS: ${typeof LOG_ACTIONS !== 'undefined' ? '✅' : '❌'}`);
            status.push(`initializeLogManager: ${typeof initializeLogManager !== 'undefined' ? '✅' : '❌'}`);
            status.push(`dataManager: ${typeof dataManager !== 'undefined' ? '✅' : '❌'}`);
            status.push(`app: ${typeof app !== 'undefined' ? '✅' : '❌'}`);
            
            updateStatus('system-status', status.join('\n'), 'ok');
        }

        // Supabase 연결 확인
        async function checkSupabaseConnection() {
            try {
                let status = [];
                
                if (typeof supabaseConfig === 'undefined') {
                    updateStatus('supabase-status', '❌ supabaseConfig 없음', 'error');
                    return;
                }
                
                status.push(`초기화 상태: ${supabaseConfig.initialized ? '✅' : '❌'}`);
                status.push(`URL: ${supabaseConfig.SUPABASE_URL ? '✅' : '❌'}`);
                status.push(`API Key: ${supabaseConfig.SUPABASE_ANON_KEY ? '✅' : '❌'}`);
                
                if (supabaseConfig.initialized) {
                    supabaseClient = supabaseConfig.getClient();
                    status.push(`클라이언트: ✅`);
                    
                    // 실제 연결 테스트
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        status.push(`연결 테스트: ❌ ${error.message}`);
                        updateStatus('supabase-status', status.join('\n'), 'error');
                    } else {
                        status.push(`연결 테스트: ✅`);
                        updateStatus('supabase-status', status.join('\n'), 'ok');
                    }
                } else {
                    updateStatus('supabase-status', status.join('\n'), 'error');
                }
                
            } catch (error) {
                updateStatus('supabase-status', `❌ 연결 실패: ${error.message}`, 'error');
            }
        }

        // 로컬 스토리지 확인
        function checkLocalStorageStatus() {
            try {
                const queue = localStorage.getItem('knou_log_queue');
                let status = [];
                
                if (queue) {
                    const parsed = JSON.parse(queue);
                    status.push(`로컬 큐: ${parsed.length}개 로그 대기 중`);
                    status.push(`큐 내용 미리보기:`);
                    status.push(JSON.stringify(parsed.slice(0, 2), null, 2));
                } else {
                    status.push(`로컬 큐: 비어있음`);
                }
                
                // 테스트 저장
                localStorage.setItem('debug_test', 'ok');
                const test = localStorage.getItem('debug_test');
                localStorage.removeItem('debug_test');
                
                status.push(`로컬 저장소 테스트: ${test === 'ok' ? '✅' : '❌'}`);
                
                updateStatus('localStorage-status', status.join('\n'), 'ok');
                
            } catch (error) {
                updateStatus('localStorage-status', `❌ 오류: ${error.message}`, 'error');
            }
        }

        // 로깅 시스템 초기화
        async function initializeLoggingSystem() {
            try {
                debugLogManager = await initializeLogManager(supabaseClient);
                
                if (debugLogManager) {
                    // 실시간 로그 모니터링 설정
                    setupLiveLogMonitoring();
                    addLiveLog('✅ 로깅 시스템 초기화 성공');
                } else {
                    addLiveLog('❌ 로깅 시스템 초기화 실패');
                }
                
            } catch (error) {
                addLiveLog(`❌ 초기화 오류: ${error.message}`);
            }
        }

        // 실제 로깅 테스트
        async function testActualLogging() {
            if (!debugLogManager) {
                addLiveLog('❌ 로깅 시스템이 초기화되지 않음');
                return;
            }

            try {
                addLiveLog('🧪 실제 로깅 테스트 시작...');
                
                // 다양한 로그 생성
                await debugLogManager.log(LOG_ACTIONS.PAGE_VIEW, 'debug_page', {
                    test: true,
                    timestamp: new Date().toISOString()
                });
                addLiveLog('✅ 페이지 뷰 로그 생성됨');
                
                await debugLogManager.log(LOG_ACTIONS.USER_VIEW, 'debug_user', {
                    userId: 999,
                    debug: true
                });
                addLiveLog('✅ 사용자 뷰 로그 생성됨');
                
                // 1초 후 Supabase에서 확인
                setTimeout(async () => {
                    await queryRecentLogs();
                }, 1000);
                
            } catch (error) {
                addLiveLog(`❌ 로깅 테스트 실패: ${error.message}`);
            }
        }

        // Supabase 테이블 확인
        async function checkSupabaseTable() {
            if (!supabaseClient) {
                updateStatus('supabase-query-result', '❌ Supabase 클라이언트 없음', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `❌ 테이블 확인 실패: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `✅ user_activity_logs 테이블 존재 (총 ${data || 0}개 로그)`;
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `❌ 오류: ${error.message}`;
            }
        }

        // 최근 로그 조회
        async function queryRecentLogs() {
            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `❌ 조회 실패: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `📊 최근 로그 ${data.length}개:\n\n` + 
                        JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `❌ 오류: ${error.message}`;
            }
        }

        // 로그 개수 확인
        async function queryLogCount() {
            if (!supabaseClient) return;

            try {
                const { count, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `❌ 개수 조회 실패: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `📊 총 로그 개수: ${count}개`;
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `❌ 오류: ${error.message}`;
            }
        }

        // 테스트 로그 직접 삽입
        async function insertTestLog() {
            if (!supabaseClient) return;

            try {
                const testLog = {
                    user_id: null,
                    action_type: 'debug_test',
                    action_target: 'direct_insert',
                    action_details: {
                        test: true,
                        method: 'direct_supabase_insert',
                        timestamp: new Date().toISOString()
                    },
                    session_id: 'debug_session_' + Date.now(),
                    metadata: {
                        debug: true,
                        source: 'debug_logging.html'
                    }
                };

                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .insert([testLog])
                    .select();
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `❌ 삽입 실패: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `✅ 테스트 로그 삽입 성공:\n\n` + 
                        JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `❌ 오류: ${error.message}`;
            }
        }

        // 모든 로컬 로그 삭제
        function clearAllLogs() {
            localStorage.removeItem('knou_log_queue');
            addLiveLog('🗑️ 로컬 로그 큐 삭제됨');
            checkLocalStorageStatus();
        }

        // 실시간 로그 모니터링 설정
        function setupLiveLogMonitoring() {
            // 기존 console.log 인터셉트
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && args[0].toString().includes('LOG') || 
                    args[0] && args[0].toString().includes('🔍') ||
                    args[0] && args[0].toString().includes('✅') ||
                    args[0] && args[0].toString().includes('❌')) {
                    addLiveLog(args.join(' '));
                }
            };
        }

        // 실시간 로그 추가
        function addLiveLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('live-logs');
            const currentLogs = logElement.textContent === '로그가 여기에 표시됩니다...' ? '' : logElement.textContent;
            
            logElement.textContent = `[${timestamp}] ${message}\n${currentLogs}`;
            
            // 로그 개수 제한
            const lines = logElement.textContent.split('\n');
            if (lines.length > 20) {
                logElement.textContent = lines.slice(0, 20).join('\n');
            }
        }

        // 상태 업데이트 헬퍼
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 페이지 로드 시 자동 진단
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnosis, 1000);
        });
    </script>
</body>
</html>