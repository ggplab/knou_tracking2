<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê¹… ì‹œìŠ¤í…œ ë””ë²„ê¹…</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f8f9fa;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 4px; 
            font-size: 12px;
        }
        .button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #000; }
        .code { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 12px; 
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .status { 
            padding: 8px 12px; 
            border-radius: 4px; 
            margin: 8px 0; 
            font-size: 13px;
        }
        .status.ok { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h3 { margin-top: 0; color: #495057; }
        .inline { display: inline-block; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ë¡œê¹… ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ë””ë²„ê¹…</h1>
        <p>í˜„ì¬ ë¡œê¹… ì‹œìŠ¤í…œì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.</p>
        
        <div>
            <button class="button success" onclick="runFullDiagnosis()">ğŸ” ì „ì²´ ì§„ë‹¨ ì‹¤í–‰</button>
            <button class="button" onclick="testActualLogging()">ğŸ“ ì‹¤ì œ ë¡œê¹… í…ŒìŠ¤íŠ¸</button>
            <button class="button" onclick="checkSupabaseTable()">ğŸ—„ï¸ Supabase í…Œì´ë¸” í™•ì¸</button>
            <button class="button warning" onclick="clearAllLogs()">ğŸ—‘ï¸ ë¡œì»¬ ë¡œê·¸ ì‚­ì œ</button>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <div id="system-status">ì§„ë‹¨ ì¤‘...</div>
        </div>
        
        <div class="container">
            <h3>Supabase ì—°ê²°</h3>
            <div id="supabase-status">í™•ì¸ ì¤‘...</div>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìƒíƒœ</h3>
            <div id="localStorage-status">í™•ì¸ ì¤‘...</div>
        </div>
        
        <div class="container">
            <h3>ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°</h3>
            <div id="live-logs" class="code">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>

    <div class="container">
        <h3>Supabase ì‹¤ì‹œê°„ í…Œì´ë¸” ì¡°íšŒ</h3>
        <button class="button inline" onclick="queryRecentLogs()">ìµœê·¼ ë¡œê·¸ ì¡°íšŒ</button>
        <button class="button inline" onclick="queryLogCount()">ë¡œê·¸ ê°œìˆ˜ í™•ì¸</button>
        <button class="button inline" onclick="insertTestLog()">í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì§ì ‘ ì‚½ì…</button>
        <div id="supabase-query-result" class="code">ì¿¼ë¦¬ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="logging.js"></script>

    <script>
        let debugLogManager = null;
        let supabaseClient = null;
        let liveLogCount = 0;

        // ì „ì²´ ì§„ë‹¨ ì‹¤í–‰
        async function runFullDiagnosis() {
            updateStatus('system-status', 'ğŸ” ì „ì²´ ì§„ë‹¨ ì‹¤í–‰ ì¤‘...', 'warning');
            
            // 1. ê¸°ë³¸ ê°ì²´ë“¤ í™•ì¸
            await checkBasicObjects();
            
            // 2. Supabase ì—°ê²° í™•ì¸
            await checkSupabaseConnection();
            
            // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
            checkLocalStorageStatus();
            
            // 4. ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            await initializeLoggingSystem();
            
            updateStatus('system-status', 'âœ… ì „ì²´ ì§„ë‹¨ ì™„ë£Œ', 'ok');
        }

        // ê¸°ë³¸ ê°ì²´ë“¤ í™•ì¸
        async function checkBasicObjects() {
            let status = [];
            
            // ì „ì—­ ê°ì²´ë“¤ í™•ì¸
            status.push(`supabaseConfig: ${typeof supabaseConfig !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            status.push(`LOG_ACTIONS: ${typeof LOG_ACTIONS !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            status.push(`initializeLogManager: ${typeof initializeLogManager !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            status.push(`dataManager: ${typeof dataManager !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            status.push(`app: ${typeof app !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            
            updateStatus('system-status', status.join('\n'), 'ok');
        }

        // Supabase ì—°ê²° í™•ì¸
        async function checkSupabaseConnection() {
            try {
                let status = [];
                
                if (typeof supabaseConfig === 'undefined') {
                    updateStatus('supabase-status', 'âŒ supabaseConfig ì—†ìŒ', 'error');
                    return;
                }
                
                status.push(`ì´ˆê¸°í™” ìƒíƒœ: ${supabaseConfig.initialized ? 'âœ…' : 'âŒ'}`);
                status.push(`URL: ${supabaseConfig.SUPABASE_URL ? 'âœ…' : 'âŒ'}`);
                status.push(`API Key: ${supabaseConfig.SUPABASE_ANON_KEY ? 'âœ…' : 'âŒ'}`);
                
                if (supabaseConfig.initialized) {
                    supabaseClient = supabaseConfig.getClient();
                    status.push(`í´ë¼ì´ì–¸íŠ¸: âœ…`);
                    
                    // ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        status.push(`ì—°ê²° í…ŒìŠ¤íŠ¸: âŒ ${error.message}`);
                        updateStatus('supabase-status', status.join('\n'), 'error');
                    } else {
                        status.push(`ì—°ê²° í…ŒìŠ¤íŠ¸: âœ…`);
                        updateStatus('supabase-status', status.join('\n'), 'ok');
                    }
                } else {
                    updateStatus('supabase-status', status.join('\n'), 'error');
                }
                
            } catch (error) {
                updateStatus('supabase-status', `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
        function checkLocalStorageStatus() {
            try {
                const queue = localStorage.getItem('knou_log_queue');
                let status = [];
                
                if (queue) {
                    const parsed = JSON.parse(queue);
                    status.push(`ë¡œì»¬ í: ${parsed.length}ê°œ ë¡œê·¸ ëŒ€ê¸° ì¤‘`);
                    status.push(`í ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:`);
                    status.push(JSON.stringify(parsed.slice(0, 2), null, 2));
                } else {
                    status.push(`ë¡œì»¬ í: ë¹„ì–´ìˆìŒ`);
                }
                
                // í…ŒìŠ¤íŠ¸ ì €ì¥
                localStorage.setItem('debug_test', 'ok');
                const test = localStorage.getItem('debug_test');
                localStorage.removeItem('debug_test');
                
                status.push(`ë¡œì»¬ ì €ì¥ì†Œ í…ŒìŠ¤íŠ¸: ${test === 'ok' ? 'âœ…' : 'âŒ'}`);
                
                updateStatus('localStorage-status', status.join('\n'), 'ok');
                
            } catch (error) {
                updateStatus('localStorage-status', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        async function initializeLoggingSystem() {
            try {
                debugLogManager = await initializeLogManager(supabaseClient);
                
                if (debugLogManager) {
                    // ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì„¤ì •
                    setupLiveLogMonitoring();
                    addLiveLog('âœ… ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
                } else {
                    addLiveLog('âŒ ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
                
            } catch (error) {
                addLiveLog(`âŒ ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì‹¤ì œ ë¡œê¹… í…ŒìŠ¤íŠ¸
        async function testActualLogging() {
            if (!debugLogManager) {
                addLiveLog('âŒ ë¡œê¹… ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                addLiveLog('ğŸ§ª ì‹¤ì œ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                
                // ë‹¤ì–‘í•œ ë¡œê·¸ ìƒì„±
                await debugLogManager.log(LOG_ACTIONS.PAGE_VIEW, 'debug_page', {
                    test: true,
                    timestamp: new Date().toISOString()
                });
                addLiveLog('âœ… í˜ì´ì§€ ë·° ë¡œê·¸ ìƒì„±ë¨');
                
                await debugLogManager.log(LOG_ACTIONS.USER_VIEW, 'debug_user', {
                    userId: 999,
                    debug: true
                });
                addLiveLog('âœ… ì‚¬ìš©ì ë·° ë¡œê·¸ ìƒì„±ë¨');
                
                // 1ì´ˆ í›„ Supabaseì—ì„œ í™•ì¸
                setTimeout(async () => {
                    await queryRecentLogs();
                }, 1000);
                
            } catch (error) {
                addLiveLog(`âŒ ë¡œê¹… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // Supabase í…Œì´ë¸” í™•ì¸
        async function checkSupabaseTable() {
            if (!supabaseClient) {
                updateStatus('supabase-query-result', 'âŒ Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `âŒ í…Œì´ë¸” í™•ì¸ ì‹¤íŒ¨: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `âœ… user_activity_logs í…Œì´ë¸” ì¡´ì¬ (ì´ ${data || 0}ê°œ ë¡œê·¸)`;
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ìµœê·¼ ë¡œê·¸ ì¡°íšŒ
        async function queryRecentLogs() {
            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `âŒ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `ğŸ“Š ìµœê·¼ ë¡œê·¸ ${data.length}ê°œ:\n\n` + 
                        JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ë¡œê·¸ ê°œìˆ˜ í™•ì¸
        async function queryLogCount() {
            if (!supabaseClient) return;

            try {
                const { count, error } = await supabaseClient
                    .from('user_activity_logs')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `âŒ ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `ğŸ“Š ì´ ë¡œê·¸ ê°œìˆ˜: ${count}ê°œ`;
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì§ì ‘ ì‚½ì…
        async function insertTestLog() {
            if (!supabaseClient) return;

            try {
                const testLog = {
                    user_id: null,
                    action_type: 'debug_test',
                    action_target: 'direct_insert',
                    action_details: {
                        test: true,
                        method: 'direct_supabase_insert',
                        timestamp: new Date().toISOString()
                    },
                    session_id: 'debug_session_' + Date.now(),
                    metadata: {
                        debug: true,
                        source: 'debug_logging.html'
                    }
                };

                const { data, error } = await supabaseClient
                    .from('user_activity_logs')
                    .insert([testLog])
                    .select();
                
                if (error) {
                    document.getElementById('supabase-query-result').textContent = 
                        `âŒ ì‚½ì… ì‹¤íŒ¨: ${error.message}`;
                } else {
                    document.getElementById('supabase-query-result').textContent = 
                        `âœ… í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì‚½ì… ì„±ê³µ:\n\n` + 
                        JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                document.getElementById('supabase-query-result').textContent = 
                    `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ëª¨ë“  ë¡œì»¬ ë¡œê·¸ ì‚­ì œ
        function clearAllLogs() {
            localStorage.removeItem('knou_log_queue');
            addLiveLog('ğŸ—‘ï¸ ë¡œì»¬ ë¡œê·¸ í ì‚­ì œë¨');
            checkLocalStorageStatus();
        }

        // ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì„¤ì •
        function setupLiveLogMonitoring() {
            // ê¸°ì¡´ console.log ì¸í„°ì…‰íŠ¸
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && args[0].toString().includes('LOG') || 
                    args[0] && args[0].toString().includes('ğŸ”') ||
                    args[0] && args[0].toString().includes('âœ…') ||
                    args[0] && args[0].toString().includes('âŒ')) {
                    addLiveLog(args.join(' '));
                }
            };
        }

        // ì‹¤ì‹œê°„ ë¡œê·¸ ì¶”ê°€
        function addLiveLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('live-logs');
            const currentLogs = logElement.textContent === 'ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...' ? '' : logElement.textContent;
            
            logElement.textContent = `[${timestamp}] ${message}\n${currentLogs}`;
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ
            const lines = logElement.textContent.split('\n');
            if (lines.length > 20) {
                logElement.textContent = lines.slice(0, 20).join('\n');
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì§„ë‹¨
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnosis, 1000);
        });
    </script>
</body>
</html>